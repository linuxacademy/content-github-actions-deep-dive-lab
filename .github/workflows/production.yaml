name: Deploy site to production bucket

on:
  push: 
   branches:
    - main
# be sure to go to the git hub settings and not allow anything w/o a pull request

jobs:
  build:
   runs-on: ubuntu-latest
   env: 
     BUCKET_NAME: cfst-3457-2bef623527c369c358815601812c-prodbucket-17rzizrmfjvm8
   steps:
    # checkout the code from github
    - name: checkout code
      uses: actions/checkout@v2
    # configure the gibhub runner w/ aws cli to get the aws access key and secret key in github settings
    - name: configure AWS CLI on runner
      uses: aws-actions/configure-aws-credentials@v1
      with:
       aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
       aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
       aws-region: us-east-1
    # because the code is gatsbyJS - a front end web dev tool - the runner needs node to later convert gatsby files to html/js/css
    - name: setup nodejs
      uses: actions/setup-node@v2
      with:
       node-version: 14
    # convert the gatsby files to html
    - name: build site
      run: |
        npm ci
        npm run build
    # copy the html/js/css files to the bucket and set it up for web hosting
    - name: deploy site to bucket
      run: |
        aws s3 cp public s3://${{ env.BUCKET_NAME }}/ --recursive --acl public-read
      